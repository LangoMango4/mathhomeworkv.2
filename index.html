<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MyMathsHomework</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#0b0e14;color:#eef3ff;font-family:Arial,sans-serif}
    .wrap{max-width:1100px;margin:32px auto;padding:16px}
    .card{background:#0f111a;border:1px solid #1d2a55;border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:22px}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:22px}
    .btn{appearance:none;border:1px solid #4a4e5a;background:#17224a;color:#eef3ff;padding:12px 20px;border-radius:12px;cursor:pointer;font-weight:600;font-size:15px}
    .btn:hover{background:#1b2a5c}
    .sb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:10px}
    .sb-btn{padding:14px;border:1px solid #2a3a7a;background:#121a36;color:#e6ecff;border-radius:12px;cursor:pointer;font-weight:600}
    .sb-btn:hover{background:#1a244a}
    .sb-btn.playing{outline:2px solid #4a5bd1; box-shadow:0 0 0 3px rgba(74,91,209,.25) inset}
    .login{display:flex;gap:8px;justify-content:center;margin-bottom:14px;flex-wrap:wrap}
    input{padding:10px 12px;border-radius:10px;border:1px solid #1d2a55;background:#0e1630;color:#eef3ff}
    .muted{opacity:.8;font-size:12px;margin-top:6px;text-align:center}
    iframe{margin:20px 0;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.3)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 style="text-align:center;margin-top:0">mathshomework v2 ðŸ˜±</h1>

      <!-- Simple login row -->
      <div class="login" id="loginRow">
        <!-- You can use either a PIN or username/password -->
        <input id="userField" placeholder="Username (or leave blank to use PIN)">
        <input id="passField" type="password" placeholder="Password or PIN">
        <button class="btn" id="loginBtn">Unlock</button>
        <div id="loginErr" class="muted" style="color:#ffcc00;display:none">Invalid credentials.</div>
        <div class="muted">Tip: Use a PIN from config, or enter <b>username + password</b>.</div>
      </div>

      <div class="top-actions">
        <button class="btn" data-tab="soundboard">Soundboard</button>
        <button class="btn" data-tab="games">Games</button>
        <button class="btn" id="adminBtn" title="Admin login">Admin</button>
      </div>

      <!-- Soundboard -->
      <div id="soundboardPage">
        <div class="sb-grid" id="sbGrid">
          <button class="sb-btn" data-sound="androidbeep">Andriod</button>
          <button class="sb-btn" data-sound="backintheday">Back in the day</button>
          <button class="sb-btn" data-sound="bingchilling">Bing Chilling</button>
          <button class="sb-btn" data-sound="clashroyal">Clash Royale</button>
          <button class="sb-btn" data-sound="crickets">Crickets</button>
          <button class="sb-btn" data-sound="crickets">Crickets</button>
          <button class="sb-btn" data-sound="fail">Fail</button>
          <button class="sb-btn" data-sound="getout">Get out</button>
          <button class="sb-btn" data-sound="goofyahhsounds">Goofy ahh sounds</button>
          <button class="sb-btn" data-sound="hogrida">Hog rida</button>
          <button class="sb-btn" data-sound="incorrectbuzzer">Incorrect Buzzer</button>
          <button class="sb-btn" data-sound="italianbrainrot">Italian brainrot</button>
          <button class="sb-btn" data-sound="legobreak">Lego Breaking</button>
          <button class="sb-btn" data-sound="lionsleep">Sleeping lion</button>
          <button class="sb-btn" data-sound="metalpipe">Metal Pipe</button>
          <button class="sb-btn" data-sound="ohio">Ohio</button>
          <button class="sb-btn" data-sound="rahhh">Rahh</button>
          <button class="sb-btn" data-sound="shutup">Shut up</button>
          <button class="sb-btn" data-sound="text">Iphone text</button>
          <button class="sb-btn" data-sound="vineboom">Vine boom</button>
          <button class="sb-btn" data-sound="what the sigma">What the sigma</button>
        </div>
      </div>

      <!-- Games -->
      <div id="gamesPage" class="hidden">
        <iframe src="https://scratch.mit.edu/projects/3041905/embed" allowtransparency="true" width="960" height="720" frameborder="0" scrolling="no" allowfullscreen></iframe>
        <iframe src="https://scratch.mit.edu/projects/17828009/embed" allowtransparency="true" width="960" height="720" frameborder="0" scrolling="no" allowfullscreen></iframe>
        <iframe src="https://scratch.mit.edu/projects/389464290/embed" allowtransparency="true" width="960" height="720" frameborder="0" scrolling="no" allowfullscreen></iframe>
        <iframe src="https://scratch.mit.edu/projects/105500895/embed" allowtransparency="true" width="960" height="720" frameborder="0" scrolling="no" allowfullscreen></iframe>
        <iframe src="https://scratch.mit.edu/projects/12575620/embed" allowtransparency="true" width="960" height="720" frameborder="0" scrolling="no" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- CONFIG (plaintext passwords) -->
  <script src="config.js"></script>

  <!-- Main logic -->
  <script>
    // ==== tab switch ====
    const tabs = { soundboard: document.getElementById('soundboardPage'), games: document.getElementById('gamesPage') };
    document.querySelectorAll('[data-tab]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = btn.getAttribute('data-tab');
        Object.entries(tabs).forEach(([k,el])=> el.classList.toggle('hidden', k!==t));
      });
    });

    // ==== auth (pins OR username/password from config) ====
    const loginBtn = document.getElementById('loginBtn');
    const loginErr = document.getElementById('loginErr');
    const loginRow = document.getElementById('loginRow');
    const userField = document.getElementById('userField');
    const passField = document.getElementById('passField');
    const adminBtn  = document.getElementById('adminBtn');

    let isAdmin = false;

    function pinsValid(pin){
      const pins = (window.MMHC?.pins)||{user:[],admin:[]};
      if (pins.admin.includes(pin)) return {ok:true,role:'admin'};
      if (pins.user.includes(pin))  return {ok:true,role:'user'};
      return {ok:false};
    }
    function accountValid(user, pass){
      const accounts = Array.isArray(window.MMHC?.accounts) ? window.MMHC.accounts : [];
      const rec = accounts.find(a => a.username.toLowerCase() === String(user).toLowerCase());
      if (!rec) return {ok:false};
      return (rec.password === pass) ? {ok:true,role:(rec.role||'user')} : {ok:false};
    }

    function setAdminUI(enabled){
      isAdmin = !!enabled;
      adminBtn.textContent = isAdmin ? "Admin (on)" : "Admin";
      adminBtn.title = isAdmin ? "Admin unlocked" : "Admin login";
    }

    loginBtn.addEventListener('click', ()=>{
      const u = userField.value.trim();
      const p = passField.value.trim();
      let auth = {ok:false,role:null};

      if (u) auth = accountValid(u,p);
      else   auth = pinsValid(p);

      if (!auth.ok){
        loginErr.style.display = 'block';
        return;
      }
      loginErr.style.display = 'none';
      loginRow.style.display = 'none';
      setAdminUI(auth.role === 'admin');
    });

    adminBtn.addEventListener('click', ()=>{
      if (isAdmin) { alert('Admin already unlocked.'); return; }
      const pin = prompt('Enter admin PIN:');
      if (!pin) return;
      const res = pinsValid(pin);
      if (res.ok && res.role === 'admin') setAdminUI(true);
      else alert('Invalid admin PIN');
    });

    // ==== soundboard ====
    function ghBasePath(){
      const override = window.MMHC?.app?.repoBaseOverride;
      if (override) return override;
      const segs = location.pathname.split('/').filter(Boolean);
      return segs.length ? `/${segs[0]}` : '';
    }
    const SOUND_BASE = `${ghBasePath()}/Sounds`;
    const SOUND_MAP  = window.MMHC?.sounds || {};
    const SOUND_META = window.MMHC?.soundMeta || {};
    const PLAYER     = window.MMHC?.player || { defaultVolume: 1.0, stopPrevious: true };

    function keyify(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'').trim(); }
    async function fileExists(url){
      try{ const r = await fetch(url, {method:'HEAD',cache:'no-store'}); return r.ok; }
      catch(_){ return false; }
    }

    let current = { key:null, audio:null, endHandler:null, timeoutId:null };
    function clearPlaying(){
      document.querySelectorAll('.sb-btn.playing').forEach(b=>b.classList.remove('playing'));
      if (current.audio && current.endHandler) current.audio.removeEventListener('ended', current.endHandler);
      if (current.timeoutId) clearTimeout(current.timeoutId);
      current = { key:null, audio:null, endHandler:null, timeoutId:null };
    }
    function applyMeta(audio, key){
      const m = SOUND_META[key] || {};
      audio.volume = typeof m.volume === 'number' ? Math.max(0,Math.min(1,m.volume)) : (PLAYER.defaultVolume ?? 1.0);
      if (current.timeoutId) clearTimeout(current.timeoutId);
      if (typeof m.maxDuration === 'number' && m.maxDuration > 0){
        current.timeoutId = setTimeout(()=>{ try{audio.pause();audio.currentTime=0;}catch(_){ } clearPlaying(); }, m.maxDuration*1000);
      }
    }

    document.getElementById('sbGrid').addEventListener('click', async (e)=>{
      const btn = e.target.closest('.sb-btn'); if (!btn) return;
      const raw = btn.getAttribute('data-sound') || btn.textContent || '';
      const key = keyify(raw);
      const file = SOUND_MAP[key];
      if (!file){ alert('Sound not mapped in config: ' + raw); return; }
      const url = `${SOUND_BASE}/${encodeURIComponent(file)}`;

      // toggle same sound
      if (current.audio && current.key === key){
        if (current.audio.paused){ try{ await current.audio.play(); btn.classList.add('playing'); }catch(_){ alert('Could not play. Tap again.'); } }
        else { current.audio.pause(); current.audio.currentTime = 0; btn.classList.remove('playing'); }
        return;
      }

      // stop previous
      if (PLAYER.stopPrevious && current.audio){ current.audio.pause(); current.audio.currentTime = 0; clearPlaying(); }

      if (!(await fileExists(url))){ alert('Missing file: ' + url); return; }

      const audio = new Audio(url);
      audio.preload = 'auto'; audio.crossOrigin = 'anonymous';
      applyMeta(audio, key);

      clearPlaying();
      current.key = key; current.audio = audio;
      btn.classList.add('playing');

      const endHandler = ()=>{ if (current.key === key){ btn.classList.remove('playing'); clearPlaying(); } };
      current.endHandler = endHandler;
      audio.addEventListener('ended', endHandler);

      try{ await audio.play(); }catch(_){ alert('Could not play. Tap again.'); }
    });
  </script>
</body>
</html>
